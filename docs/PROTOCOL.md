# Half-Tunnel Protocol Specification

Version: 1.0

## Overview

The Half-Tunnel protocol is a binary protocol designed for efficient split-path tunneling over WebSocket connections. It provides UUID-based session correlation, stream multiplexing, and optional HMAC authentication.

## Packet Format

### Header (34 bytes)

```
Offset  Size  Field       Description
──────────────────────────────────────────────────────────────
0       2     Magic       Protocol identifier (0x48, 0x54 = "HT")
2       1     Version     Protocol version (currently 0x01)
3       1     Flags       Packet type and options
4       16    SessionID   UUID v4 for session correlation
20      4     StreamID    Logical connection identifier
24      4     SeqNum      Sequence number for ordering
28      4     AckNum      Acknowledgment number
32      2     PayloadLen  Payload size (0-65535)
```

### Payload (0-65535 bytes)

Variable-length payload containing encrypted application data.

### HMAC (32 bytes, optional)

HMAC-SHA256 authentication tag when FlagHMAC is set.

## Flags

| Bit | Name       | Value | Description                           |
|-----|------------|-------|---------------------------------------|
| 0   | DATA       | 0x01  | Packet contains application data      |
| 1   | ACK        | 0x02  | Acknowledgment packet                 |
| 2   | FIN        | 0x04  | Connection termination                |
| 3   | KEEPALIVE  | 0x08  | Keep-alive ping                       |
| 4   | HANDSHAKE  | 0x10  | Session establishment                 |
| 7   | HMAC       | 0x80  | HMAC authentication present           |

Flags can be combined. For example, `DATA | ACK` (0x03) indicates a data packet that also acknowledges received data.

## Session Lifecycle

### 1. Handshake

```
Client                                    Server
   │                                         │
   │──── HANDSHAKE (SessionID) ──────────────▶│  (via Upstream/Domain A)
   │                                         │
   │◀─── HANDSHAKE+ACK (SessionID) ──────────│  (via Downstream/Domain B)
   │                                         │
```

### 2. Data Transfer

```
Client                                    Server
   │                                         │
   │──── DATA (StreamID, SeqNum) ────────────▶│  (via Upstream)
   │                                         │
   │◀─── DATA (StreamID, SeqNum) ────────────│  (via Downstream)
   │                                         │
   │──── ACK (AckNum) ───────────────────────▶│  (via Upstream)
   │                                         │
```

### 3. Stream Termination

```
Client                                    Server
   │                                         │
   │──── FIN (StreamID) ─────────────────────▶│
   │                                         │
   │◀─── FIN+ACK (StreamID) ─────────────────│
   │                                         │
```

## Stream States

| State       | Description                              |
|-------------|------------------------------------------|
| OPEN        | Initial state, handshake in progress     |
| ACTIVE      | Data can flow in both directions         |
| HALF_CLOSED | One direction closed (FIN received)      |
| CLOSED      | Both directions closed                   |

## Sequence Numbers

- Sequence numbers start at 0 for each stream
- Each packet increments the sender's sequence number by 1
- Receivers use SeqNum for ordering and duplicate detection
- AckNum indicates the next expected SeqNum

## Session ID

- UUID v4 (128-bit random identifier)
- Generated by client on first connection
- Persisted for session resumption after reconnection
- Server uses SessionID to correlate upstream and downstream packets

## Stream ID

- 32-bit unsigned integer
- Allocated by client (odd numbers) or server (even numbers)
- StreamID 0 is reserved for control messages
- Maximum 2^32-1 streams per session

## Encryption

When encryption is enabled:

1. Payload is encrypted with AES-256-GCM
2. Session key is derived during handshake
3. Nonce is prepended to encrypted payload (12 bytes)
4. Authentication tag is appended (16 bytes)

## HMAC Authentication

When FlagHMAC is set:

1. HMAC-SHA256 is computed over the entire packet (excluding HMAC field)
2. 32-byte tag is appended after payload
3. Receiver verifies HMAC before processing

## Error Handling

### Malformed Packets

- Invalid magic: Close connection immediately
- Unknown version: Send error response, close connection
- Invalid flags: Ignore packet
- HMAC mismatch: Ignore packet

### Connection Failures

- Upstream failure: Queue packets, attempt reconnection
- Downstream failure: Queue responses, attempt reconnection
- Session timeout: Server evicts session after idle timeout

## Wire Examples

### Handshake Packet

```
48 54                       # Magic "HT"
01                          # Version 1
10                          # Flags: HANDSHAKE
550e8400-e29b-41d4-a716-446655440000  # SessionID (16 bytes)
00 00 00 00                 # StreamID: 0 (control)
00 00 00 00                 # SeqNum: 0
00 00 00 00                 # AckNum: 0
00 00                       # PayloadLen: 0
```

### Data Packet

```
48 54                       # Magic "HT"
01                          # Version 1
01                          # Flags: DATA
550e8400-e29b-41d4-a716-446655440000  # SessionID
00 00 00 01                 # StreamID: 1
00 00 00 05                 # SeqNum: 5
00 00 00 04                 # AckNum: 4
00 0C                       # PayloadLen: 12
48 65 6C 6C 6F 20 57 6F 72 6C 64 21  # Payload: "Hello World!"
```

## Security Considerations

1. **Session ID Privacy**: SessionID correlates traffic; use encryption
2. **Replay Protection**: SeqNum prevents replay attacks within a session
3. **HMAC Requirement**: Enable HMAC for integrity in untrusted networks
4. **TLS Recommended**: Always use WSS (WebSocket Secure) in production
